{
  "url": "https://api.github.com/repos/alibaba/weex/issues/1380",
  "repository_url": "https://api.github.com/repos/alibaba/weex",
  "labels_url": "https://api.github.com/repos/alibaba/weex/issues/1380/labels{/name}",
  "comments_url": "https://api.github.com/repos/alibaba/weex/issues/1380/comments",
  "events_url": "https://api.github.com/repos/alibaba/weex/issues/1380/events",
  "html_url": "https://github.com/alibaba/weex/issues/1380",
  "id": 182157324,
  "number": 1380,
  "title": "android上< slider > 组件在元素个数为2时，无法设置slider的index属性",
  "user": {
    "login": "bigconvience",
    "id": 1308834,
    "avatar_url": "https://avatars3.githubusercontent.com/u/1308834?v=3",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bigconvience",
    "html_url": "https://github.com/bigconvience",
    "followers_url": "https://api.github.com/users/bigconvience/followers",
    "following_url": "https://api.github.com/users/bigconvience/following{/other_user}",
    "gists_url": "https://api.github.com/users/bigconvience/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bigconvience/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bigconvience/subscriptions",
    "organizations_url": "https://api.github.com/users/bigconvience/orgs",
    "repos_url": "https://api.github.com/users/bigconvience/repos",
    "events_url": "https://api.github.com/users/bigconvience/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bigconvience/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": [
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/252802248",
      "html_url": "https://github.com/alibaba/weex/issues/1380#issuecomment-252802248",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/1380",
      "id": 252802248,
      "user": {
        "login": "fkysly",
        "id": 3274605,
        "avatar_url": "https://avatars1.githubusercontent.com/u/3274605?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fkysly",
        "html_url": "https://github.com/fkysly",
        "followers_url": "https://api.github.com/users/fkysly/followers",
        "following_url": "https://api.github.com/users/fkysly/following{/other_user}",
        "gists_url": "https://api.github.com/users/fkysly/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/fkysly/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/fkysly/subscriptions",
        "organizations_url": "https://api.github.com/users/fkysly/orgs",
        "repos_url": "https://api.github.com/users/fkysly/repos",
        "events_url": "https://api.github.com/users/fkysly/events{/privacy}",
        "received_events_url": "https://api.github.com/users/fkysly/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2016-10-11T03:28:04Z",
      "updated_at": "2016-10-11T03:28:04Z",
      "body": "Please add a description of the effect.\n\n@YorkShen \n"
    }
  ],
  "created_at": "2016-10-11T02:15:07Z",
  "updated_at": "2016-10-11T05:54:21Z",
  "closed_at": "2016-10-11T05:54:21Z",
  "body": "在android上使用slider组件时，且数据个数为2时，设置slider的index为0之后，slider的index会变成1，且无法循环滚动，效果如下所示：\n![device-2016-10-11-100953](https://cloud.githubusercontent.com/assets/1308834/19256665/a79e199c-8f9b-11e6-8db5-4da94987a4eb.gif)\nslider中的元素在切换到第一个之后，突然会跳到第二个。其原因跟WXCircleViewPager中的 _setCurrentItem()_函数的代码有关：\n\n```\n  public void setCurrentItem(int item, boolean smoothScroll) {\n    if (getAdapter().getCount() == 0) {\n      super.setCurrentItem(item, smoothScroll);\n      return;\n    }\n    item = getOffsetAmount() + (item % getAdapter().getCount());\n    super.setCurrentItem(item, smoothScroll);\n  }\n```\n\n此函数调用的_getOffsetAmount()_返回的结果会用当前元素的个数乘以50：\n\n```\n  private int getOffsetAmount() {\n    if (getAdapter().getCount() == 0) {\n      return 0;\n    }\n    if (getAdapter() instanceof WXCirclePageAdapter) {\n      WXCirclePageAdapter infAdapter = (WXCirclePageAdapter) getAdapter();\n      // allow for 100 back cycles from the beginning\n      // should be enough to create an illusion of infinity\n      // warning: scrolling to very high values (1,000,000+) results in\n      // strange drawing behaviour\n      return infAdapter.getRealCount() * 50;\n    } else {\n      return 0;\n    }\n  }\n```\n\n由于adapter中的元素个数为2，该函数返回的结果为100. 而ViewPager类的设置显示元素的index的代码如下：\n\n```\n   void setCurrentItemInternal(int item, boolean smoothScroll, boolean always, int velocity) {\n        if (mAdapter == null || mAdapter.getCount() <= 0) {\n            setScrollingCacheEnabled(false);\n            return;\n        }\n        if (!always && mCurItem == item && mItems.size() != 0) {\n            setScrollingCacheEnabled(false);\n            return;\n        }\n\n        if (item < 0) {\n            item = 0;\n        } else if (item >= mAdapter.getCount()) {\n            item = mAdapter.getCount() - 1;\n        }\n       ......\n}\n```\n\n此时的item为100， 而adapter中的_getCount()_返回的值为2：\n\n```\n  public int getCount() {\n    // if count less than 3,the circle doesn't work as expected.\n    int count = getRealCount();\n    if (count > 2) {\n      return count * 110;\n    } else {\n      return count;\n    }\n\n  }\n```\n\n故item的值会被设置成1. 可见，slider控件为了实现循环滚动效果，对2个元素做了特殊处理, 只需对_WXCircleViewPager_的函数进行如下修改即可：\n\n```\n  private int getOffsetAmount() {\n    if (getAdapter().getCount() == 0) {\n      return 0;\n    }\n    if (getAdapter() instanceof WXCirclePageAdapter) {\n      WXCirclePageAdapter infAdapter = (WXCirclePageAdapter) getAdapter();\n      // allow for 100 back cycles from the beginning\n      // should be enough to create an illusion of infinity\n      // warning: scrolling to very high values (1,000,000+) results in\n      // strange drawing behaviour\n      int realCount = infAdapter.getRealCount();\n      return realCount> 2 ? realCount * 50 : 0;\n    } else {\n      return 0;\n    }\n  }\n```\n",
  "closed_by": {
    "login": "sospartan",
    "id": 115201,
    "avatar_url": "https://avatars0.githubusercontent.com/u/115201?v=3",
    "gravatar_id": "",
    "url": "https://api.github.com/users/sospartan",
    "html_url": "https://github.com/sospartan",
    "followers_url": "https://api.github.com/users/sospartan/followers",
    "following_url": "https://api.github.com/users/sospartan/following{/other_user}",
    "gists_url": "https://api.github.com/users/sospartan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/sospartan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sospartan/subscriptions",
    "organizations_url": "https://api.github.com/users/sospartan/orgs",
    "repos_url": "https://api.github.com/users/sospartan/repos",
    "events_url": "https://api.github.com/users/sospartan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/sospartan/received_events",
    "type": "User",
    "site_admin": false
  }
}
