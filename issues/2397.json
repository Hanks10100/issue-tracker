{
  "url": "https://api.github.com/repos/alibaba/weex/issues/2397",
  "repository_url": "https://api.github.com/repos/alibaba/weex",
  "labels_url": "https://api.github.com/repos/alibaba/weex/issues/2397/labels{/name}",
  "comments_url": "https://api.github.com/repos/alibaba/weex/issues/2397/comments",
  "events_url": "https://api.github.com/repos/alibaba/weex/issues/2397/events",
  "html_url": "https://github.com/alibaba/weex/issues/2397",
  "id": 202732293,
  "number": 2397,
  "title": "-[WXBridgeManager _runLoopThread] crash",
  "user": {
    "login": "willice9527",
    "id": 8385824,
    "avatar_url": "https://avatars2.githubusercontent.com/u/8385824?v=3",
    "gravatar_id": "",
    "url": "https://api.github.com/users/willice9527",
    "html_url": "https://github.com/willice9527",
    "followers_url": "https://api.github.com/users/willice9527/followers",
    "following_url": "https://api.github.com/users/willice9527/following{/other_user}",
    "gists_url": "https://api.github.com/users/willice9527/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/willice9527/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/willice9527/subscriptions",
    "organizations_url": "https://api.github.com/users/willice9527/orgs",
    "repos_url": "https://api.github.com/users/willice9527/repos",
    "events_url": "https://api.github.com/users/willice9527/events{/privacy}",
    "received_events_url": "https://api.github.com/users/willice9527/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": [
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/274738229",
      "html_url": "https://github.com/alibaba/weex/issues/2397#issuecomment-274738229",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/2397",
      "id": 274738229,
      "user": {
        "login": "CodeLife2012",
        "id": 4277861,
        "avatar_url": "https://avatars1.githubusercontent.com/u/4277861?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/CodeLife2012",
        "html_url": "https://github.com/CodeLife2012",
        "followers_url": "https://api.github.com/users/CodeLife2012/followers",
        "following_url": "https://api.github.com/users/CodeLife2012/following{/other_user}",
        "gists_url": "https://api.github.com/users/CodeLife2012/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/CodeLife2012/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/CodeLife2012/subscriptions",
        "organizations_url": "https://api.github.com/users/CodeLife2012/orgs",
        "repos_url": "https://api.github.com/users/CodeLife2012/repos",
        "events_url": "https://api.github.com/users/CodeLife2012/events{/privacy}",
        "received_events_url": "https://api.github.com/users/CodeLife2012/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2017-01-24T08:23:16Z",
      "updated_at": "2017-01-24T08:23:36Z",
      "body": "观察了下貌似是`CFRunLoopSourceSignal`时source里面的lock为空，但不知道为何会发生"
    },
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/274744291",
      "html_url": "https://github.com/alibaba/weex/issues/2397#issuecomment-274744291",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/2397",
      "id": 274744291,
      "user": {
        "login": "cxfeng1",
        "id": 1625893,
        "avatar_url": "https://avatars2.githubusercontent.com/u/1625893?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/cxfeng1",
        "html_url": "https://github.com/cxfeng1",
        "followers_url": "https://api.github.com/users/cxfeng1/followers",
        "following_url": "https://api.github.com/users/cxfeng1/following{/other_user}",
        "gists_url": "https://api.github.com/users/cxfeng1/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/cxfeng1/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/cxfeng1/subscriptions",
        "organizations_url": "https://api.github.com/users/cxfeng1/orgs",
        "repos_url": "https://api.github.com/users/cxfeng1/repos",
        "events_url": "https://api.github.com/users/cxfeng1/events{/privacy}",
        "received_events_url": "https://api.github.com/users/cxfeng1/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2017-01-24T08:52:34Z",
      "updated_at": "2017-01-24T08:53:20Z",
      "body": "@willice9527 \r\n\r\n1. 采用创建NSThread并绑定runloop的方式，主要用于Native和JS的频发通信以及component线程16ms一次的layout计算，Weex的整个渲染机制基于三线程的架构， 采用NSThread可以对线程有更直接的控制。\r\n2. 这个是好建议， 已提PR #2401 ， merge之后发个小版本给你们\r\n3. 目前也有接入的App是在controller的viewdidload中进行初始化的， 没有发现类似的crash， 是否能提供和 [WXSDKEngine initSDKEnviroment] 同时触发的其他Weex相关操作， 怀疑是runloop内部死锁了。 另外也可以尝试一下将初始化方法往前移， 初始化方法在主线程的耗时不高， 大部分App都是放到启动的时候进行初始化。\r\n\r\n如有任何问题， 欢迎直接回复issue。\r\n\r\n"
    },
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/274775736",
      "html_url": "https://github.com/alibaba/weex/issues/2397#issuecomment-274775736",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/2397",
      "id": 274775736,
      "user": {
        "login": "willice9527",
        "id": 8385824,
        "avatar_url": "https://avatars2.githubusercontent.com/u/8385824?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willice9527",
        "html_url": "https://github.com/willice9527",
        "followers_url": "https://api.github.com/users/willice9527/followers",
        "following_url": "https://api.github.com/users/willice9527/following{/other_user}",
        "gists_url": "https://api.github.com/users/willice9527/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/willice9527/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/willice9527/subscriptions",
        "organizations_url": "https://api.github.com/users/willice9527/orgs",
        "repos_url": "https://api.github.com/users/willice9527/repos",
        "events_url": "https://api.github.com/users/willice9527/events{/privacy}",
        "received_events_url": "https://api.github.com/users/willice9527/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2017-01-24T11:13:41Z",
      "updated_at": "2017-01-24T11:13:41Z",
      "body": "@cxfeng1   [WXSDKEngine initSDKEnviroment]的同时应该是没有其它weex相关操作的，在init完成后，才进行当前viewcontroller所持有的WXSDKInstance的创建及调用renderWithURL:方法 "
    },
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/275301048",
      "html_url": "https://github.com/alibaba/weex/issues/2397#issuecomment-275301048",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/2397",
      "id": 275301048,
      "user": {
        "login": "acton393",
        "id": 11631084,
        "avatar_url": "https://avatars1.githubusercontent.com/u/11631084?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/acton393",
        "html_url": "https://github.com/acton393",
        "followers_url": "https://api.github.com/users/acton393/followers",
        "following_url": "https://api.github.com/users/acton393/following{/other_user}",
        "gists_url": "https://api.github.com/users/acton393/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/acton393/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/acton393/subscriptions",
        "organizations_url": "https://api.github.com/users/acton393/orgs",
        "repos_url": "https://api.github.com/users/acton393/repos",
        "events_url": "https://api.github.com/users/acton393/events{/privacy}",
        "received_events_url": "https://api.github.com/users/acton393/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2017-01-26T03:37:57Z",
      "updated_at": "2017-01-26T03:38:28Z",
      "body": "hi @willice9527  可以尝试一下 `0.9.5.2` [这里](https://cocoapods.org/pods/WeexSDK) 版本，这个版本是要发布的 0.10 的版本feature，有修复上面 @cxfeng1  提到的一些问题， 如果还有其他问题，可以继续在下面回复， thx~~~"
    },
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/281233553",
      "html_url": "https://github.com/alibaba/weex/issues/2397#issuecomment-281233553",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/2397",
      "id": 281233553,
      "user": {
        "login": "willice9527",
        "id": 8385824,
        "avatar_url": "https://avatars2.githubusercontent.com/u/8385824?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willice9527",
        "html_url": "https://github.com/willice9527",
        "followers_url": "https://api.github.com/users/willice9527/followers",
        "following_url": "https://api.github.com/users/willice9527/following{/other_user}",
        "gists_url": "https://api.github.com/users/willice9527/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/willice9527/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/willice9527/subscriptions",
        "organizations_url": "https://api.github.com/users/willice9527/orgs",
        "repos_url": "https://api.github.com/users/willice9527/repos",
        "events_url": "https://api.github.com/users/willice9527/events{/privacy}",
        "received_events_url": "https://api.github.com/users/willice9527/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2017-02-21T03:11:44Z",
      "updated_at": "2017-02-21T03:11:44Z",
      "body": "我们计划在这个版本升级至0.10.0 到时候再看看是否还有这个问题。\r\n@acton393 "
    },
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/282272683",
      "html_url": "https://github.com/alibaba/weex/issues/2397#issuecomment-282272683",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/2397",
      "id": 282272683,
      "user": {
        "login": "acton393",
        "id": 11631084,
        "avatar_url": "https://avatars1.githubusercontent.com/u/11631084?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/acton393",
        "html_url": "https://github.com/acton393",
        "followers_url": "https://api.github.com/users/acton393/followers",
        "following_url": "https://api.github.com/users/acton393/following{/other_user}",
        "gists_url": "https://api.github.com/users/acton393/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/acton393/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/acton393/subscriptions",
        "organizations_url": "https://api.github.com/users/acton393/orgs",
        "repos_url": "https://api.github.com/users/acton393/repos",
        "events_url": "https://api.github.com/users/acton393/events{/privacy}",
        "received_events_url": "https://api.github.com/users/acton393/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2017-02-24T11:44:34Z",
      "updated_at": "2017-02-24T11:44:34Z",
      "body": "hi @willice9527  ok， issue 暂时先关闭了， 如果后续有问题，可以再打开回复"
    }
  ],
  "created_at": "2017-01-24T06:02:42Z",
  "updated_at": "2017-02-24T11:44:34Z",
  "closed_at": "2017-02-24T11:44:34Z",
  "body": "hi,各位\r\n问题描述：我们这边iOS应用接入weex大约有两个月左右时间。接入以来，我们陆续收到了一些+[WXSDKEngine initSDKEnviroment]过程中产生的crash。大约累计产生了7000余次，对稳定性还是产生了一些影响。查了crash stacktrace，发现崩溃发生在-[WXBridgeManager _runLoopThread]。具体的stacktrace，我附了两个典型的作为附件，如果你们需要查看更多，也可以联系我这边(jinlin.liu@ele.me)。目前我们在iOS9/10两个系统环境下启用weex，崩溃的发生也是分布在两个系统上 。整体上来说，这个bug的崩溃率比较低，难以人为复现。相似的崩溃在-[WXComponentManager _runLoopThread]也有发生，stacktrace也非常类似。这个累计约1500余次。\r\n另外还有一些使用上的疑问，想要向这边咨询一下：\r\n1.WXBridgeManager WXComponentManager都使用了常驻线程的做法，相较于dispatch_queue，当时如何取舍的？出于何种考虑使用常驻thread的方式 ？\r\n2.thread的入口方法没有使用autoreleasepool?可能是我们理解粗浅，不过可能会有一些leak？\r\n3.出于不影响主业务流程的考虑，我们将[WXSDKEngine initSDKEnviroment]时机放的比较靠后。在第一次进入weex页面的控制器的viewdidload方法中调用，随后才进行WXSDKInstance 的renderWithURL。上面的问题与这个较迟的初始化时机是否有关联。\r\n[WXBridgeManager_crash_stacktrace01.txt](https://github.com/alibaba/weex/files/725763/WXBridgeManager_crash_stacktrace01.txt)\r\n[WXBridgeManager_crash_stacktrace02.txt](https://github.com/alibaba/weex/files/725764/WXBridgeManager_crash_stacktrace02.txt)\r\n[WXComponentManager_crash_stacktrace01.txt](https://github.com/alibaba/weex/files/725765/WXComponentManager_crash_stacktrace01.txt)\r\n[WXComponentManager_crash_stacktrace02.txt](https://github.com/alibaba/weex/files/725766/WXComponentManager_crash_stacktrace02.txt)\r\n\r\n期待回复\r\n\r\n\r\n"
}
