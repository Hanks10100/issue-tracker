{
  "url": "https://api.github.com/repos/alibaba/weex/issues/1175",
  "repository_url": "https://api.github.com/repos/alibaba/weex",
  "labels_url": "https://api.github.com/repos/alibaba/weex/issues/1175/labels{/name}",
  "comments_url": "https://api.github.com/repos/alibaba/weex/issues/1175/comments",
  "events_url": "https://api.github.com/repos/alibaba/weex/issues/1175/events",
  "html_url": "https://github.com/alibaba/weex/issues/1175",
  "id": 175697567,
  "number": 1175,
  "title": "同样网络请求的代码，h5和native运行结果不一样",
  "user": {
    "login": "kfeagle",
    "id": 11485145,
    "avatar_url": "https://avatars0.githubusercontent.com/u/11485145?v=3",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kfeagle",
    "html_url": "https://github.com/kfeagle",
    "followers_url": "https://api.github.com/users/kfeagle/followers",
    "following_url": "https://api.github.com/users/kfeagle/following{/other_user}",
    "gists_url": "https://api.github.com/users/kfeagle/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kfeagle/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kfeagle/subscriptions",
    "organizations_url": "https://api.github.com/users/kfeagle/orgs",
    "repos_url": "https://api.github.com/users/kfeagle/repos",
    "events_url": "https://api.github.com/users/kfeagle/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kfeagle/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "sospartan",
    "id": 115201,
    "avatar_url": "https://avatars0.githubusercontent.com/u/115201?v=3",
    "gravatar_id": "",
    "url": "https://api.github.com/users/sospartan",
    "html_url": "https://github.com/sospartan",
    "followers_url": "https://api.github.com/users/sospartan/followers",
    "following_url": "https://api.github.com/users/sospartan/following{/other_user}",
    "gists_url": "https://api.github.com/users/sospartan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/sospartan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sospartan/subscriptions",
    "organizations_url": "https://api.github.com/users/sospartan/orgs",
    "repos_url": "https://api.github.com/users/sospartan/repos",
    "events_url": "https://api.github.com/users/sospartan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/sospartan/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "sospartan",
      "id": 115201,
      "avatar_url": "https://avatars0.githubusercontent.com/u/115201?v=3",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sospartan",
      "html_url": "https://github.com/sospartan",
      "followers_url": "https://api.github.com/users/sospartan/followers",
      "following_url": "https://api.github.com/users/sospartan/following{/other_user}",
      "gists_url": "https://api.github.com/users/sospartan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sospartan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sospartan/subscriptions",
      "organizations_url": "https://api.github.com/users/sospartan/orgs",
      "repos_url": "https://api.github.com/users/sospartan/repos",
      "events_url": "https://api.github.com/users/sospartan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sospartan/received_events",
      "type": "User",
      "site_admin": false
    },
    {
      "login": "MrRaindrop",
      "id": 1545874,
      "avatar_url": "https://avatars3.githubusercontent.com/u/1545874?v=3",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MrRaindrop",
      "html_url": "https://github.com/MrRaindrop",
      "followers_url": "https://api.github.com/users/MrRaindrop/followers",
      "following_url": "https://api.github.com/users/MrRaindrop/following{/other_user}",
      "gists_url": "https://api.github.com/users/MrRaindrop/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MrRaindrop/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MrRaindrop/subscriptions",
      "organizations_url": "https://api.github.com/users/MrRaindrop/orgs",
      "repos_url": "https://api.github.com/users/MrRaindrop/repos",
      "events_url": "https://api.github.com/users/MrRaindrop/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MrRaindrop/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": [
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/254123767",
      "html_url": "https://github.com/alibaba/weex/issues/1175#issuecomment-254123767",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/1175",
      "id": 254123767,
      "user": {
        "login": "MrRaindrop",
        "id": 1545874,
        "avatar_url": "https://avatars3.githubusercontent.com/u/1545874?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MrRaindrop",
        "html_url": "https://github.com/MrRaindrop",
        "followers_url": "https://api.github.com/users/MrRaindrop/followers",
        "following_url": "https://api.github.com/users/MrRaindrop/following{/other_user}",
        "gists_url": "https://api.github.com/users/MrRaindrop/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/MrRaindrop/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/MrRaindrop/subscriptions",
        "organizations_url": "https://api.github.com/users/MrRaindrop/orgs",
        "repos_url": "https://api.github.com/users/MrRaindrop/repos",
        "events_url": "https://api.github.com/users/MrRaindrop/events{/privacy}",
        "received_events_url": "https://api.github.com/users/MrRaindrop/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2016-10-17T06:36:14Z",
      "updated_at": "2016-10-17T06:36:14Z",
      "body": "此问题已在html5-feature-0.4分支做了修复\n"
    }
  ],
  "created_at": "2016-09-08T08:45:31Z",
  "updated_at": "2016-10-17T06:36:15Z",
  "closed_at": "2016-10-17T06:36:14Z",
  "body": "<!--\n0. It's ***RECOMMENDED*** to [submit PR](https://github.com/alibaba/weex/pulls) for typo, new demo or tiny bugfix.\n0. If this's a ***BUG***, pls provide: course repetition, error/crash log, device model, OS version, App version (playground or other apps).\n0. If this's a ***FEATURE***, pls provide: details, pseudo codes if necessary.\n\n---\n\n（请在***提交***前删除这段描述）\n\n0. 我们***推荐***小问题直接[提 PR](https://github.com/alibaba/weex/pulls)，如错别字、新 demo 或 bugfix。\n0. 如果是 ***Bug***，请提供：复现步骤（推荐有截图）、error/crash log、设备型号、OS 版本、App 版本（playground 版本或自己的 app）。\n0. 如果是***新需求***，请提供：详细描述、应用场景、适当的伪代码（如有）。\n-->\n## 问题简介：\n\nnative 和 h5 同样网络请求的代码，运行结果不一样\n## 原因：\n\nH5上 stream的fetch 对type 为jsonp(跨域扩展) 和json的封装不一致,在iOS上他们的封装是一致的\n## 现象：\n\nh5\n![h5](https://raw.githubusercontent.com/kfeagle/firstdemo/master/h5.png)\n\nnative\n![native](https://raw.githubusercontent.com/kfeagle/firstdemo/master/native.png)\n## demo代码\n\nweex 自带的demo代码\nhttps://github.com/alibaba/weex/blob/dev/examples/module/stream-demo.we\n\n``` javascript\nstream.fetch({\n        method: 'GET',\n        url: GET_URL_JSONP,\n        type:'jsonp'\n      }, function(ret) {\n        debugger\n        if(!ret.ok){\n          me.getJsonpResult = \"request failed\";\n        }else{\n          console.log('get:'+ret);\n          me.getJsonpResult =  JSON.stringify(ret.data);\n        }\n      },function(response){\n        console.log('get jsonp in progress:'+response.length);\n        me.getJsonpResult = \"bytes received:\"+response.length;\n      });\n```\n## 问题代码\n\nh5  网络请求代码位置 https://github.com/alibaba/weex/blob/dev/html5/browser/extend/api/stream.js\njson 网络请求数据封装\n\n``` javascript\n xhr.onload = function (res) {\n    callback({\n      status: xhr.status,\n      ok: xhr.status >= 200 && xhr.status < 300,\n      statusText: xhr.statusText,\n      data: xhr.response,\n      headers: xhr.getAllResponseHeaders().split('\\n')\n        .reduce(function (obj, headerStr) {\n          const headerArr = headerStr.match(/(.+): (.+)/)\n          if (headerArr) {\n            obj[headerArr[1]] = headerArr[2]\n          }\n          return obj\n        }, {})\n    })\n  }\n```\n\njsonp 网络请求数据未封装\n\n``` javascript\nglobal[cbName] = (function (cb) {\n    return function (response) {\n      callback(response)\n      delete global[cb]\n    }\n  })(cbName)\n```\n## 临时解决方案\n\n我个人对stream.js 的jsonp 格式封装\n\n``` javascript\nglobal[cbName] = (function (cb) {\n    return function (response) {\n\n\n     //我添加的代码\n      var res = {}\n      res['ok'] = true\n      res['data'] = response\n\n      callback(res)\n      delete global[cb]\n    }\n  })(cbName)\n\n```\n",
  "closed_by": {
    "login": "MrRaindrop",
    "id": 1545874,
    "avatar_url": "https://avatars3.githubusercontent.com/u/1545874?v=3",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MrRaindrop",
    "html_url": "https://github.com/MrRaindrop",
    "followers_url": "https://api.github.com/users/MrRaindrop/followers",
    "following_url": "https://api.github.com/users/MrRaindrop/following{/other_user}",
    "gists_url": "https://api.github.com/users/MrRaindrop/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MrRaindrop/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MrRaindrop/subscriptions",
    "organizations_url": "https://api.github.com/users/MrRaindrop/orgs",
    "repos_url": "https://api.github.com/users/MrRaindrop/repos",
    "events_url": "https://api.github.com/users/MrRaindrop/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MrRaindrop/received_events",
    "type": "User",
    "site_admin": false
  }
}
