{
  "url": "https://api.github.com/repos/alibaba/weex/issues/1249",
  "repository_url": "https://api.github.com/repos/alibaba/weex",
  "labels_url": "https://api.github.com/repos/alibaba/weex/issues/1249/labels{/name}",
  "comments_url": "https://api.github.com/repos/alibaba/weex/issues/1249/comments",
  "events_url": "https://api.github.com/repos/alibaba/weex/issues/1249/events",
  "html_url": "https://github.com/alibaba/weex/issues/1249",
  "id": 177742232,
  "number": 1249,
  "title": "[Android]WXStreamModule获取emoji表情问题",
  "user": {
    "login": "zjutkz",
    "id": 9446934,
    "avatar_url": "https://avatars1.githubusercontent.com/u/9446934?v=3",
    "gravatar_id": "",
    "url": "https://api.github.com/users/zjutkz",
    "html_url": "https://github.com/zjutkz",
    "followers_url": "https://api.github.com/users/zjutkz/followers",
    "following_url": "https://api.github.com/users/zjutkz/following{/other_user}",
    "gists_url": "https://api.github.com/users/zjutkz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/zjutkz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/zjutkz/subscriptions",
    "organizations_url": "https://api.github.com/users/zjutkz/orgs",
    "repos_url": "https://api.github.com/users/zjutkz/repos",
    "events_url": "https://api.github.com/users/zjutkz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/zjutkz/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [],
  "state": "closed",
  "locked": false,
  "assignee": null,
  "assignees": [],
  "milestone": null,
  "comments": [
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/247970301",
      "html_url": "https://github.com/alibaba/weex/issues/1249#issuecomment-247970301",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/1249",
      "id": 247970301,
      "user": {
        "login": "sospartan",
        "id": 115201,
        "avatar_url": "https://avatars0.githubusercontent.com/u/115201?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sospartan",
        "html_url": "https://github.com/sospartan",
        "followers_url": "https://api.github.com/users/sospartan/followers",
        "following_url": "https://api.github.com/users/sospartan/following{/other_user}",
        "gists_url": "https://api.github.com/users/sospartan/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/sospartan/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/sospartan/subscriptions",
        "organizations_url": "https://api.github.com/users/sospartan/orgs",
        "repos_url": "https://api.github.com/users/sospartan/repos",
        "events_url": "https://api.github.com/users/sospartan/events{/privacy}",
        "received_events_url": "https://api.github.com/users/sospartan/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2016-09-19T11:37:11Z",
      "updated_at": "2016-09-19T11:37:11Z",
      "body": "@zjutkz 欢迎来提交对应的PR\n@YorkShen 目前text也还不支持emoji吧\n"
    },
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/247974598",
      "html_url": "https://github.com/alibaba/weex/issues/1249#issuecomment-247974598",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/1249",
      "id": 247974598,
      "user": {
        "login": "YorkShen",
        "id": 4162544,
        "avatar_url": "https://avatars2.githubusercontent.com/u/4162544?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/YorkShen",
        "html_url": "https://github.com/YorkShen",
        "followers_url": "https://api.github.com/users/YorkShen/followers",
        "following_url": "https://api.github.com/users/YorkShen/following{/other_user}",
        "gists_url": "https://api.github.com/users/YorkShen/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/YorkShen/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/YorkShen/subscriptions",
        "organizations_url": "https://api.github.com/users/YorkShen/orgs",
        "repos_url": "https://api.github.com/users/YorkShen/repos",
        "events_url": "https://api.github.com/users/YorkShen/events{/privacy}",
        "received_events_url": "https://api.github.com/users/YorkShen/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2016-09-19T12:01:24Z",
      "updated_at": "2016-09-19T12:01:24Z",
      "body": "weex android目前不支持emoji，会crash。 @zjutkz \n"
    },
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/247975582",
      "html_url": "https://github.com/alibaba/weex/issues/1249#issuecomment-247975582",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/1249",
      "id": 247975582,
      "user": {
        "login": "zjutkz",
        "id": 9446934,
        "avatar_url": "https://avatars1.githubusercontent.com/u/9446934?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/zjutkz",
        "html_url": "https://github.com/zjutkz",
        "followers_url": "https://api.github.com/users/zjutkz/followers",
        "following_url": "https://api.github.com/users/zjutkz/following{/other_user}",
        "gists_url": "https://api.github.com/users/zjutkz/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/zjutkz/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zjutkz/subscriptions",
        "organizations_url": "https://api.github.com/users/zjutkz/orgs",
        "repos_url": "https://api.github.com/users/zjutkz/repos",
        "events_url": "https://api.github.com/users/zjutkz/events{/privacy}",
        "received_events_url": "https://api.github.com/users/zjutkz/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2016-09-19T12:07:17Z",
      "updated_at": "2016-09-19T12:07:17Z",
      "body": "@YorkShen 你的意思是即使能解析的出来，在对应的Text组件里使用了emoji就会crash吗？(没看过text组件的源码，不太清楚这方面的逻辑)，如果是的话，之后会支持吗？\n"
    },
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/248188053",
      "html_url": "https://github.com/alibaba/weex/issues/1249#issuecomment-248188053",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/1249",
      "id": 248188053,
      "user": {
        "login": "YorkShen",
        "id": 4162544,
        "avatar_url": "https://avatars2.githubusercontent.com/u/4162544?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/YorkShen",
        "html_url": "https://github.com/YorkShen",
        "followers_url": "https://api.github.com/users/YorkShen/followers",
        "following_url": "https://api.github.com/users/YorkShen/following{/other_user}",
        "gists_url": "https://api.github.com/users/YorkShen/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/YorkShen/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/YorkShen/subscriptions",
        "organizations_url": "https://api.github.com/users/YorkShen/orgs",
        "repos_url": "https://api.github.com/users/YorkShen/repos",
        "events_url": "https://api.github.com/users/YorkShen/events{/privacy}",
        "received_events_url": "https://api.github.com/users/YorkShen/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2016-09-20T02:54:25Z",
      "updated_at": "2016-09-20T02:54:25Z",
      "body": "Ref #350  @zjutkz \n"
    },
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/248819950",
      "html_url": "https://github.com/alibaba/weex/issues/1249#issuecomment-248819950",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/1249",
      "id": 248819950,
      "user": {
        "login": "zjutkz",
        "id": 9446934,
        "avatar_url": "https://avatars1.githubusercontent.com/u/9446934?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/zjutkz",
        "html_url": "https://github.com/zjutkz",
        "followers_url": "https://api.github.com/users/zjutkz/followers",
        "following_url": "https://api.github.com/users/zjutkz/following{/other_user}",
        "gists_url": "https://api.github.com/users/zjutkz/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/zjutkz/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zjutkz/subscriptions",
        "organizations_url": "https://api.github.com/users/zjutkz/orgs",
        "repos_url": "https://api.github.com/users/zjutkz/repos",
        "events_url": "https://api.github.com/users/zjutkz/events{/privacy}",
        "received_events_url": "https://api.github.com/users/zjutkz/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2016-09-22T06:05:34Z",
      "updated_at": "2016-09-22T06:05:34Z",
      "body": "@YorkShen 关于emoji的问题，当我在通过stream.fetch去获取网络数据之后，在WXStreamModule的对应成功回调中打断点，发现[得到的数据是这样的](https://github.com/zjutkz/weex/blob/dev/android/problems/weex_emoji_1.png)\n可以看到emoji被转义了，而这样我正常的TextView中是可以显示的，但是当我把断点打到了WXBridgeManager的callNative方法中时，[数据变成了这样](https://github.com/zjutkz/weex/blob/dev/android/problems/weex_emoji_2.png)\n可以看到，emoji变成了其他奇怪的字符，而不是像之前一样转义的。\nWXStreamModule的回调中正确，可以确定网络数据是没有问题的，但是WXBridgeManager的callNative方法中出了错，说明JSFramework层处理的时候把它变成了错误的东西，这个是v8的问题吗？还是其他什么原因？\n"
    },
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/248831829",
      "html_url": "https://github.com/alibaba/weex/issues/1249#issuecomment-248831829",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/1249",
      "id": 248831829,
      "user": {
        "login": "YorkShen",
        "id": 4162544,
        "avatar_url": "https://avatars2.githubusercontent.com/u/4162544?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/YorkShen",
        "html_url": "https://github.com/YorkShen",
        "followers_url": "https://api.github.com/users/YorkShen/followers",
        "following_url": "https://api.github.com/users/YorkShen/following{/other_user}",
        "gists_url": "https://api.github.com/users/YorkShen/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/YorkShen/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/YorkShen/subscriptions",
        "organizations_url": "https://api.github.com/users/YorkShen/orgs",
        "repos_url": "https://api.github.com/users/YorkShen/repos",
        "events_url": "https://api.github.com/users/YorkShen/events{/privacy}",
        "received_events_url": "https://api.github.com/users/YorkShen/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2016-09-22T07:29:15Z",
      "updated_at": "2016-09-22T07:29:15Z",
      "body": "emoji不是modified UTF-8字符，Android NDK只支持Modified UTF-8，处理其他UTF-8字符，会出现异常现象。 https://developer.android.com/training/articles/perf-jni.html#UTF_8_and_UTF_16_strings @zavakid \n"
    },
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/248835875",
      "html_url": "https://github.com/alibaba/weex/issues/1249#issuecomment-248835875",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/1249",
      "id": 248835875,
      "user": {
        "login": "zjutkz",
        "id": 9446934,
        "avatar_url": "https://avatars1.githubusercontent.com/u/9446934?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/zjutkz",
        "html_url": "https://github.com/zjutkz",
        "followers_url": "https://api.github.com/users/zjutkz/followers",
        "following_url": "https://api.github.com/users/zjutkz/following{/other_user}",
        "gists_url": "https://api.github.com/users/zjutkz/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/zjutkz/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/zjutkz/subscriptions",
        "organizations_url": "https://api.github.com/users/zjutkz/orgs",
        "repos_url": "https://api.github.com/users/zjutkz/repos",
        "events_url": "https://api.github.com/users/zjutkz/events{/privacy}",
        "received_events_url": "https://api.github.com/users/zjutkz/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2016-09-22T07:54:30Z",
      "updated_at": "2016-09-22T07:54:30Z",
      "body": "@YorkShen OK,thanks\n"
    },
    {
      "url": "https://api.github.com/repos/alibaba/weex/issues/comments/248856847",
      "html_url": "https://github.com/alibaba/weex/issues/1249#issuecomment-248856847",
      "issue_url": "https://api.github.com/repos/alibaba/weex/issues/1249",
      "id": 248856847,
      "user": {
        "login": "YorkShen",
        "id": 4162544,
        "avatar_url": "https://avatars2.githubusercontent.com/u/4162544?v=3",
        "gravatar_id": "",
        "url": "https://api.github.com/users/YorkShen",
        "html_url": "https://github.com/YorkShen",
        "followers_url": "https://api.github.com/users/YorkShen/followers",
        "following_url": "https://api.github.com/users/YorkShen/following{/other_user}",
        "gists_url": "https://api.github.com/users/YorkShen/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/YorkShen/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/YorkShen/subscriptions",
        "organizations_url": "https://api.github.com/users/YorkShen/orgs",
        "repos_url": "https://api.github.com/users/YorkShen/repos",
        "events_url": "https://api.github.com/users/YorkShen/events{/privacy}",
        "received_events_url": "https://api.github.com/users/YorkShen/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2016-09-22T09:46:35Z",
      "updated_at": "2016-09-22T09:46:35Z",
      "body": "参考这个[commit](https://android-review.googlesource.com/#/c/130121/), android 6.0 ndk不会crash，6.0以下的版本有可能crash。考虑使用byte[]数组进行数据通讯，绕过这个问题，参考这个提交，目前还没有验证64位系统和jni泄露 https://github.com/sospartan/weex/tree/android-bugfix-utf-8 。这个issue先关闭，进度跟踪 Ref #350 @zjutkz \n"
    }
  ],
  "created_at": "2016-09-19T09:43:41Z",
  "updated_at": "2016-09-22T09:46:35Z",
  "closed_at": "2016-09-22T09:46:35Z",
  "body": "如果通过stream去请求数据，type设置成json，并且后台接口返回的数据中包含emoji表情的话，emoji会解析失败，并且在特定情况下会造成json的解析失败。\n原因是因为在WXStreamModule的fetch方法中，当走到成功的回调以后，会调用readAsString方法去将byte数组转换成String：\n`String respData = readAsString(response.originalData,\n                headers!=null?headers.get(\"Content-Type\"):\"\"\n              );`\n在转化的过程中emoji是无法解析的，这是第一个问题。\n第二问题是在特定情况下偶发的，如果这个emoji是位于字符串的最后一个位置，那么在byte[]转化成String的过程中，后引号会丢失，就像这样：\n后台下发的是\"xxxxxxxxx😄\"，通过byte[]换成成String之后，变成了\"xxxxxxxxxxxo쌩Ģ,可以看到后引号丢失了。\n所以我的建议是\n`resp.put(\"data\",options.getType() != Options.Type.text? JSONObject.parse(respData):respData);`\n在转化成json的时候，入参不要是String，fastJson提供了入参是byte[]的方法，直接用比较合适。\n至于转换成String之后emoji丢失的情况。。。貌似没什么好的办法。\n"
}
